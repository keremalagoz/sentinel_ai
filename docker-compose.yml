# SENTINEL AI - Docker Compose Configuration
# Sprint 0.2: Full service definitions
# Usage: docker-compose up -d

version: '3.8'

services:
  # ============================================
  # Service 1: WhiteRabbitNeo LLM (Port 8002)
  # ============================================
  whiterabbitneo-service:
    build:
      context: .
      dockerfile: docker/whiterabbitneo/Dockerfile
    container_name: sentinel-whiterabbitneo
    ports:
      - "8002:11434"  # External:Internal
    volumes:
      - whiterabbitneo_models:/root/.ollama  # Model cache
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_GPU_LAYERS=99
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    restart: unless-stopped
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 300s  # Model indirme icin 5 dakika bekle
    networks:
      - sentinel-net

  # ============================================
  # Service 3: API Backend (Port 8000)
  # ============================================
  api-service:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: sentinel-api
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data  # Database persistence
      - ./temp:/app/temp  # Temporary files
    env_file:
      - .env
    environment:
      - DB_PATH=/app/data/sentinel_api.db
    depends_on:
      - whiterabbitneo-service
    restart: unless-stopped
    networks:
      - sentinel-net

  # ============================================
  # Service 4: Security Tools (Nmap, Gobuster, etc.)
  # ============================================
  tools-service:
    build:
      context: .
      dockerfile: docker/tools/Dockerfile
    container_name: sentinel-tools
    volumes:
      - ./temp:/app/output  # Scan results
    networks:
      - sentinel-net
    cap_add:
      - NET_RAW      # Nmap -sS icin gerekli
      - NET_ADMIN    # Network tarama icin gerekli
    restart: unless-stopped
    stdin_open: true
    tty: true

# Named volumes for model persistence
volumes:
  whiterabbitneo_models:
    driver: local

# Custom network for service isolation
networks:
  sentinel-net:
    driver: bridge
